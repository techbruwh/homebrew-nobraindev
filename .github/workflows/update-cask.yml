name: Update Cask

on:
  repository_dispatch:
    types: [update-cask]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., 0.1.0)'
        required: true
      arm_sha:
        description: 'SHA256 for ARM64 build'
        required: true
      intel_sha:
        description: 'SHA256 for Intel build'
        required: true

jobs:
  update-cask:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Update cask formula
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ARM_SHA="${{ github.event.inputs.arm_sha }}"
          INTEL_SHA="${{ github.event.inputs.intel_sha }}"
          
          cat > Casks/nobraindev.rb << EOL
          cask "nobraindev" do
            version "$VERSION"
          
            on_arm do
              url "https://github.com/techbruwh/nobraindev/releases/download/v#{version}/NoBrainDev_#{version}_aarch64.dmg"
              sha256 "$ARM_SHA"
            end
          
            on_intel do
              url "https://github.com/techbruwh/nobraindev/releases/download/v#{version}/NoBrainDev_#{version}_x64.dmg"
              sha256 "$INTEL_SHA"
            end
          
            name "NoBrainDev"
            desc "AI-powered code snippet manager with semantic search"
            homepage "https://github.com/techbruwh/nobraindev"
          
            livecheck do
              url :url
              strategy :github_latest
            end
          
            app "NoBrainDev.app", target: "No Brain Dev.app"
          
            zap trash: [
              "~/.local/share/nobraindev",
              "~/Library/Application Support/com.techbruwh.nobraindev",
              "~/Library/Caches/com.techbruwh.nobraindev",
              "~/Library/Preferences/com.techbruwh.nobraindev.plist",
            ]
          end
          EOL

      - name: Run brew audit
        run: |
          brew tap techbruwh/nobraindev $GITHUB_WORKSPACE
          brew audit --cask --strict techbruwh/nobraindev/nobraindev

      - name: Run brew style
        run: brew style --fix Casks/nobraindev.rb

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}
          commit-message: "Update NoBrainDev to v${{ github.event.inputs.version }}"
          title: "Update NoBrainDev to v${{ github.event.inputs.version }}"
          body: |
            Updates NoBrainDev to version ${{ github.event.inputs.version }}
            
            - Updated version number
            - Updated SHA256 checksums for both architectures
            - Passed `brew audit` check
            - Applied style fixes
          branch: update-cask
          delete-branch: true
          committer: GitHub Action <action@github.com>
          author: GitHub Action <action@github.com>